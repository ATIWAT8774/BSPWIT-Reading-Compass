<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSPWIT Reading Compass</title>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg: #dfe6e9;
            --white: #ffffff;
            --text: #2d3436;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Mitr', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login Screen */
        #screen-login {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #6c5ce7, #0984e3);
        }
        .login-card {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 20px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-logo { width: 120px; margin-bottom: 20px; }

        /* General UI */
        .form-control {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px;
            margin-bottom: 15px; font-family: 'Mitr'; font-size: 1rem; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            background: var(--primary); color: white; font-size: 1rem; cursor: pointer;
            transition: 0.3s; font-family: 'Mitr';
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }
        .btn-sm { padding: 5px 10px; width: auto; font-size: 0.9rem; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid #ddd; color: #555; }

        /* Header */
        .header {
            background: var(--white); padding: 10px 20px; display: flex; 
            justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo-img { width: 50px; height: 50px; object-fit: contain; }
        .user-info h3 { margin: 0; font-size: 1.1rem; }
        .user-info small { color: var(--primary); font-weight: 500; }
        
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }

        /* Slider */
        .slider-box {
            aspect-ratio: 8 / 3; width: 100%; max-width: 1000px;
            margin: 0 auto 20px auto; background: #fff; border-radius: 15px; 
            overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .slide-img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: 0.5s; }
        .slide-img.active { opacity: 1; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .menu-item {
            background: var(--white); padding: 20px; border-radius: 15px; text-align: center;
            cursor: pointer; transition: 0.3s; box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        .menu-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .menu-icon { font-size: 2rem; color: var(--primary); display: block; margin-bottom: 10px; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            display: none; align-items: center; justify-content: center; z-index: 99;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white); width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; padding: 25px; border-radius: 20px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .close-btn {
            position: absolute; top: 15px; right: 15px; border: none; background: #f1f2f6;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 1.2rem;
        }

        /* List Items */
        .list-item {
            background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; color: white; }
        .bg-ok { background: var(--success); }
        .bg-wait { background: var(--warning); color: #333; }
        .bg-used { background: var(--danger); }
        .bg-new { background: #0984e3; }
        .bg-reject { background: var(--danger); }

        .prog-track { background: #eee; height: 15px; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .prog-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: 0.5s; }

        /* Leaderboard */
        .rank-item { display: flex; align-items: center; margin-bottom: 12px; background: #fff; padding: 10px; border-radius: 10px; }
        .rank-num { width: 30px; font-weight: bold; color: #888; text-align: center; font-size: 1.1rem; }
        .rank-info { flex: 1; padding: 0 10px; }
        .rank-name { font-size: 0.95rem; font-weight: 500; margin-bottom: 4px; display: block; }
        .bar-container { background: #f1f2f6; height: 10px; border-radius: 5px; width: 100%; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 1s ease-out; }
        .rank-count { font-weight: bold; color: var(--primary); font-size: 0.9rem; margin-left: 10px; min-width: 60px; text-align: right; }
        .rank-1 .rank-num { color: #f1c40f; text-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1.5rem; }
        .rank-2 .rank-num { color: #95a5a6; font-size: 1.3rem; }
        .rank-3 .rank-num { color: #e67e22; font-size: 1.3rem; }

        /* Badge */
        .notify-badge {
            position: absolute; top: 10px; right: 10px; background: #ff4757; color: white;
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);
            z-index: 5; transition: 0.3s;
        }
        .notify-badge:not(.hidden) { animation: popIn 0.5s; }
        @keyframes popIn { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        @media(max-width: 500px) { .grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div id="page-login" class="fade-in">
        <div id="screen-login">
            <div class="login-card">
                <img src="https://img2.pic.in.th/pic/LOGO-SAPA-3.png" class="login-logo" alt="Logo">
                <h2 style="margin-top:0;">BSPWIT Reading Compass</h2>
                <p style="color:#666; margin-bottom:20px;">เข็มทิศการอ่าน บางสะพานวิทยา</p>
                <form onsubmit="handleLogin(event)">
                    <input id="log_id" class="form-control" placeholder="เลขประจำตัวนักเรียน / ID" required>
                    <input id="log_pass" type="password" class="form-control" placeholder="รหัสผ่าน" required>
                    <button type="submit" class="btn">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>
    </div>

    <div id="page-student" class="hidden fade-in">
        <div class="header">
            <div class="brand">
                <img src="https://img2.pic.in.th/pic/LOGO-SAPA-3.png" class="logo-img" alt="Logo">
                <div class="user-info">
                    <h3 id="st-name">Name</h3>
                    <small>นักเรียน</small>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-sm btn-danger"><i class="bi bi-box-arrow-right"></i></button>
        </div>
        <div class="container">
            <div id="st-slider" class="slider-box"></div>
            <div class="grid">
                <div class="menu-item" onclick="openRecord()">
                    <i class="bi bi-pencil-square menu-icon"></i> <span>บันทึกการอ่าน</span>
                </div>
                <div class="menu-item" onclick="openHistory()">
                    <i class="bi bi-clock-history menu-icon"></i> <span>ประวัติ</span>
                </div>
                <div class="menu-item" onclick="openLeaderboard()">
                    <i class="bi bi-bar-chart-line-fill menu-icon"></i> <span>จัดอันดับนักอ่าน</span>
                </div>
                <div class="menu-item" onclick="openCoupons()">
                    <i class="bi bi-ticket-perforated-fill menu-icon"></i> <span>คูปอง</span>
                </div>
            </div>
        </div>
    </div>

    <div id="page-librarian" class="hidden fade-in">
        <div class="header">
            <div class="brand">
                <img src="https://img2.pic.in.th/pic/LOGO-SAPA-3.png" class="logo-img" alt="Logo">
                <div class="user-info">
                    <h3 id="lib-name">Name</h3>
                    <small>บรรณารักษ์</small>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-sm btn-danger"><i class="bi bi-box-arrow-right"></i></button>
        </div>
        <div class="container">
            <div id="lib-slider" class="slider-box"></div>
            <div class="grid">
                <div class="menu-item" onclick="openPending()" style="position:relative;">
                    <div id="badge-pending" class="notify-badge hidden">0</div>
                    <i class="bi bi-check-circle-fill menu-icon"></i> <span>คำขออนุมัติ</span>
                </div>
                <div class="menu-item" onclick="openRedeem()">
                    <i class="bi bi-qr-code-scan menu-icon"></i> <span>แลกคูปอง</span>
                </div>
                <div class="menu-item" onclick="openLeaderboard()">
                    <i class="bi bi-bar-chart-line-fill menu-icon"></i> <span>ดูอันดับยอดอ่าน</span>
                </div>
                <div class="menu-item" onclick="openUsers()">
                    <i class="bi bi-people-fill menu-icon"></i> <span>จัดการผู้ใช้</span>
                </div>
                <div class="menu-item" onclick="openSlides()">
                    <i class="bi bi-images menu-icon"></i> <span>จัดการสไลด์</span>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-record" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-record')">×</button>
            <h3>บันทึกการอ่าน</h3>
            <form onsubmit="submitRecord(event)">
                <input id="rec-title" class="form-control" placeholder="ชื่อหนังสือ" required>
                <input id="rec-auth" class="form-control" placeholder="ชื่อผู้แต่ง" required>
                <input id="rec-pub" class="form-control" placeholder="สำนักพิมพ์" required>
                <div style="display:flex; gap:10px;">
                    <input id="rec-year" class="form-control" placeholder="ปีที่พิมพ์" required>
                    <input id="rec-pages" type="number" class="form-control" placeholder="จำนวนหน้า" required>
                </div>
                <textarea id="rec-sum" class="form-control" rows="3" placeholder="เนื้อเรื่องโดยย่อ" required></textarea>
                <textarea id="rec-less" class="form-control" rows="3" placeholder="สรุปใจความสำคัญ/สาระที่ได้จากเรื่อง" required></textarea>
                <button type="submit" class="btn">บันทึกข้อมูล</button>
            </form>
        </div>
    </div>

    <div id="modal-history" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-history')">×</button>
            <h3>ประวัติการอ่าน</h3>
            <div class="prog-track"><div id="prog-bar" class="prog-fill"></div></div>
            <div style="text-align:center; margin-bottom:15px;"><small id="prog-text">0/10 เล่ม</small></div>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="modal-coupons" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-coupons')">×</button>
            <h3>คูปองของฉัน</h3>
            <div id="coupon-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="modal-pending" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-pending')">×</button>
            <h3>รายการรอตรวจสอบ</h3>
            <div id="pending-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="modal-view-detail" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-view-detail')">×</button>
            <h3>รายละเอียดการอ่าน</h3>
            <div id="view-body" style="background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:15px; font-size: 0.9rem;"></div>
            <div style="display:flex; gap:10px;">
                <button id="btn-approve" class="btn btn-success">อนุมัติ</button>
                <button id="btn-reject" class="btn btn-danger">ไม่ผ่าน</button>
            </div>
        </div>
    </div>

    <div id="modal-redeem" class="modal">
        <div class="modal-content" style="text-align:center;">
            <button class="close-btn" onclick="closeModal('modal-redeem')">×</button>
            <h3>แลกคูปอง</h3>
            <div id="redeem-step-1">
                <i class="bi bi-qr-code-scan" style="font-size:3rem; color:#ccc;"></i>
                <form onsubmit="checkCoupon(event)" style="margin-top:15px;">
                    <input id="rd-code" class="form-control" placeholder="BSP-XXXX" style="text-align:center; font-size:1.5rem; text-transform:uppercase;" required>
                    <button type="submit" class="btn">ตรวจสอบ</button>
                </form>
            </div>
            <div id="redeem-step-2" class="hidden fade-in">
                <div style="background:#f0fff4; border:2px solid #00b894; border-radius:15px; padding:20px; margin-bottom:20px;">
                    <h4 style="color:#00b894;">คูปองถูกต้อง</h4>
                    <h2 id="show-owner-name">-</h2>
                    <p id="show-owner-id">ID: -</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="resetRedeem()" class="btn" style="background:#ccc; color:#333;">ยกเลิก</button>
                    <button onclick="confirmRedeem()" class="btn btn-danger">ยืนยันตัดคูปอง</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-leaderboard" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-leaderboard')">×</button>
            <h3 style="text-align: center;">อันดับยอดนักอ่าน</h3>
            <div id="leaderboard-list">กำลังโหลด...</div>
        </div>
    </div>

    <div id="modal-users" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-users')">×</button>
            <h3>จัดการผู้ใช้</h3>
            <form onsubmit="addUser(event)" style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:15px;">
                <div style="display:flex; gap:5px;"><input id="u-id" class="form-control" placeholder="ID" required style="margin:0;"><input id="u-birth" class="form-control" placeholder="รหัสผ่าน" required style="margin:0;"></div>
                <div style="display:flex; gap:5px; margin-top:5px;"><input id="u-name" class="form-control" placeholder="ชื่อ" required style="margin:0;"><input id="u-sur" class="form-control" placeholder="นามสกุล" required style="margin:0;"></div>
                <select id="u-role" class="form-control" style="margin-top:5px;"><option value="student">Student</option><option value="librarian">Librarian</option></select>
                <button type="submit" class="btn btn-sm btn-success" style="margin-top:5px; width:100%;">เพิ่มผู้ใช้</button>
            </form>
            <div id="users-list"></div>
        </div>
    </div>

    <div id="modal-slides" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modal-slides')">×</button>
            <h3>จัดการสไลด์</h3>
            <form onsubmit="addSlideFile(event)" style="margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:12px;">
                <input type="file" id="s-file" class="form-control" accept="image/*" required>
                <div style="display:flex; gap:5px;"><input id="s-title" class="form-control" placeholder="หัวข้อ"><input type="number" id="s-order" class="form-control" placeholder="ลำดับ" value="1" style="width:80px;"></div>
                <button type="submit" class="btn btn-sm btn-success" style="width:100%;">อัปโหลด</button>
            </form>
            <div id="slides-list">กำลังโหลด...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwQDe6UI07fVsyzjj53cHnFiuYITE94ub0dNhFy9Z5Y8Mcpy27mLiVwBwl9DKIJdo4Brg/exec';
        let curUser = null;
        let slideTimer = null;
        let updateInterval = null;

        // --- Session & Logic ---
        function checkSession() {
            const u = localStorage.getItem('lib_user');
            if(u) {
                curUser = JSON.parse(u);
                showPage(curUser.role === 'student' ? 'page-student' : 'page-librarian');
                if(curUser.role==='student') {
                    document.getElementById('st-name').innerText = curUser.name;
                    loadSlides('st-slider');
                } else {
                    document.getElementById('lib-name').innerText = curUser.name;
                    loadSlides('lib-slider');
                    startAutoUpdate();
                }
            }
        }
        window.onload = checkSession;

        async function api(data) {
            try {
                const r = await fetch(API_URL, { method:'POST', body:JSON.stringify(data) });
                return await r.json();
            } catch(e) { return {success:false}; }
        }

        function showPage(id) {
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('page-student').classList.add('hidden');
            document.getElementById('page-librarian').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function handleLogin(e) {
            e.preventDefault();
            const res = await api({
                action: 'login',
                student_id: document.getElementById('log_id').value,
                birthdate: document.getElementById('log_pass').value
            });
            if(res.success) {
                localStorage.setItem('lib_user', JSON.stringify(res.user));
                location.reload();
            } else { Swal.fire('ล้มเหลว', res.message, 'error'); }
        }

        function logout() {
            localStorage.removeItem('lib_user');
            location.reload();
        }

        // --- Student Features ---
        function openRecord() { document.getElementById('modal-record').classList.add('active'); }
        async function submitRecord(e) {
            e.preventDefault();
            const res = await api({
                action: 'save_log', student_id: curUser.id,
                title: document.getElementById('rec-title').value,
                author: document.getElementById('rec-auth').value,
                pub: document.getElementById('rec-pub').value,
                year: document.getElementById('rec-year').value,
                pages: document.getElementById('rec-pages').value,
                summary: document.getElementById('rec-sum').value,
                lesson: document.getElementById('rec-less').value
            });
            if(res.success) {
                Swal.fire('สำเร็จ', 'ส่งบันทึกแล้ว รอการตรวจสอบ', 'success');
                closeModal('modal-record'); e.target.reset();
            }
        }

        async function openHistory() {
            document.getElementById('modal-history').classList.add('active');
            const res = await api({ action: 'get_student_data', student_id: curUser.id });
            const c = res.data.approved % 10;
            document.getElementById('prog-bar').style.width = (c*10)+'%';
            document.getElementById('prog-text').innerText = c+'/10 เล่ม';
            document.getElementById('history-list').innerHTML = res.data.logs.map(l => `
                <div class="list-item">
                    <div><b>${l.title}</b><br><small>${new Date(l.date).toLocaleDateString()}</small></div>
                    <span class="badge ${l.status==='approved'?'bg-ok':(l.status==='rejected'?'bg-reject':'bg-wait')}">
                        ${l.status==='approved'?'ผ่าน':(l.status==='rejected'?'ไม่ผ่าน':'รอตรวจ')}
                    </span>
                </div>`).join('');
        }

        async function openCoupons() {
            document.getElementById('modal-coupons').classList.add('active');
            const res = await api({ action: 'get_student_data', student_id: curUser.id });
            document.getElementById('coupon-list').innerHTML = res.data.coupons.map(c => `
                <div class="list-item">
                    <div><b>${c.code}</b><br><small>${c.status==='New'?'ใช้ได้':'ใช้แล้ว'}</small></div>
                    <span class="badge ${c.status==='New'?'bg-new':'bg-used'}">${c.status}</span>
                </div>`).join('');
        }

        // --- Librarian Features ---
        async function openPending() {
            document.getElementById('modal-pending').classList.add('active');
            const res = await api({ action: 'get_pending_logs' });
            document.getElementById('pending-list').innerHTML = res.data.map(l => `
                <div class="list-item" style="display:block;">
                    <div style="display:flex;justify-content:space-between;"><b>ID: ${l.sid}</b> <small>${l.title}</small></div>
                    <button onclick="viewDetail('${l.id}', '${l.sid}', '${l.title}', '${l.author}', '${l.pub}', '${l.year}', '${l.pages}', \`${l.summary}\`, \`${l.lesson}\`)" class="btn btn-sm btn-outline" style="width:100%;margin-top:5px;">ตรวจสอบ</button>
                </div>`).join('') || 'ไม่มีรายการค้าง';
        }

        function viewDetail(id, sid, title, auth, pub, year, pages, sum, less) {
            closeModal('modal-pending');
            document.getElementById('modal-view-detail').classList.add('active');
            document.getElementById('view-body').innerHTML = `
                <p><b>เล่ม:</b> ${title} (${auth})</p>
                <p><b>สนพ:</b> ${pub} | <b>ปี:</b> ${year} | <b>หน้า:</b> ${pages}</p><hr>
                <p><b>เนื้อหา:</b> ${sum}</p><p><b>ข้อคิด:</b> ${less}</p>
            `;
            document.getElementById('btn-approve').onclick = () => processLog(id, sid, 'approve');
            document.getElementById('btn-reject').onclick = () => processLog(id, sid, 'reject');
        }

        async function processLog(id, sid, type) {
            const res = await api({ action: type === 'approve' ? 'approve_log' : 'reject_log', log_id: id, student_id: sid });
            Swal.fire('เรียบร้อย', res.message, 'success');
            closeModal('modal-view-detail');
            openPending();
        }

        // --- ระบบอัตโนมัติ & สไลด์ ---
        function startAutoUpdate() { checkPendingCount(); updateInterval = setInterval(checkPendingCount, 10000); }
        async function checkPendingCount() {
            if(!curUser || curUser.role !== 'librarian') return;
            const res = await api({ action: 'get_pending_logs' });
            if(res.success) {
                const badge = document.getElementById('badge-pending');
                if(res.data.length > 0) { badge.innerText = res.data.length; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); }
            }
        }

        async function loadSlides(elemId) {
            const box = document.getElementById(elemId);
            const res = await api({ action:'get_slides', onlyActive:true });
            if(res.success && res.data.length > 0) {
                box.innerHTML = res.data.map((s,i) => `<img src="${s.url}" class="slide-img ${i===0?'active':''}">`).join('');
                let idx=0; if(slideTimer) clearInterval(slideTimer);
                slideTimer = setInterval(() => {
                    idx = (idx+1)%res.data.length;
                    box.querySelectorAll('.slide-img').forEach((el,i) => el.classList.toggle('active', i===idx));
                }, 5000);
            }
        }

        async function openLeaderboard() {
            document.getElementById('modal-leaderboard').classList.add('active');
            const res = await api({ action: 'get_leaderboard' });
            if (res.success) {
                const max = res.data[0]?.count || 1;
                document.getElementById('leaderboard-list').innerHTML = res.data.map((u, i) => `
                    <div class="rank-item">
                        <div class="rank-num">${i+1}</div>
                        <div class="rank-info"><span>${u.name}</span><div class="bar-container"><div class="bar-fill" style="width:${(u.count/max)*100}%"></div></div></div>
                        <div class="rank-count">${u.count} เล่ม</div>
                    </div>`).join('');
            }
        }

        // --- ส่วนที่เหลือ (Redeem, Users, Slides) ---
        function openRedeem() { document.getElementById('modal-redeem').classList.add('active'); resetRedeem(); }
        function resetRedeem() { document.getElementById('redeem-step-1').classList.remove('hidden'); document.getElementById('redeem-step-2').classList.add('hidden'); document.getElementById('rd-code').value = ''; }
        async function checkCoupon(e) {
            e.preventDefault();
            const res = await api({ action: 'check_coupon', coupon_code: document.getElementById('rd-code').value });
            if(res.success) {
                document.getElementById('redeem-step-1').classList.add('hidden');
                document.getElementById('redeem-step-2').classList.remove('hidden');
                document.getElementById('show-owner-name').innerText = res.data.name;
                document.getElementById('show-owner-id').innerText = 'ID: ' + res.data.sid;
                window.curCoupon = res.data.code;
            } else { Swal.fire('ผิดพลาด', res.message, 'error'); }
        }
        async function confirmRedeem() {
            const res = await api({ action: 'redeem_coupon', coupon_code: window.curCoupon, librarian_name: curUser.name });
            if(res.success) { Swal.fire('สำเร็จ', 'ตัดคูปองแล้ว', 'success'); closeModal('modal-redeem'); }
        }

        async function openUsers() { document.getElementById('modal-users').classList.add('active'); loadUsers(); }
        async function loadUsers() {
            const res = await api({ action:'get_users' });
            document.getElementById('users-list').innerHTML = res.data.map(u => `
                <div class="list-item">
                    <div><b>${u.id}</b> ${u.name}</div>
                    <button onclick="delUser('${u.id}')" class="btn btn-sm btn-danger">ลบ</button>
                </div>`).join('');
        }
        async function addUser(e) {
            e.preventDefault();
            await api({ action:'save_user', id:document.getElementById('u-id').value, name:document.getElementById('u-name').value, surname:document.getElementById('u-sur').value, birth:document.getElementById('u-birth').value, role:document.getElementById('u-role').value });
            e.target.reset(); loadUsers();
        }
        async function delUser(id) { await api({action:'delete_user', student_id:id}); loadUsers(); }

        async function openSlides() { document.getElementById('modal-slides').classList.add('active'); loadEditSlides(); }
        async function loadEditSlides() {
            const res = await api({ action:'get_slides', onlyActive:false });
            document.getElementById('slides-list').innerHTML = res.data.map(s => `
                <div class="list-item">
                    <img src="${s.url}" width="40" height="30" style="object-fit:cover;">
                    <div style="flex:1;margin-left:10px;">${s.title}</div>
                    <button onclick="togSlide('${s.id}', ${!s.active})" class="btn btn-sm ${s.active?'btn-success':'btn-danger'}">${s.active?'ON':'OFF'}</button>
                    <button onclick="delSlide('${s.id}')" class="btn btn-sm btn-danger" style="margin-left:5px;">ลบ</button>
                </div>`).join('');
        }
        async function addSlideFile(e) {
            e.preventDefault();
            const file = document.getElementById('s-file').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function() {
                await api({ action: 'save_slide_file', fileData: reader.result.split(',')[1], fileName: file.name, mimeType: file.type, title: document.getElementById('s-title').value, order: document.getElementById('s-order').value });
                e.target.reset(); loadEditSlides();
            };
        }
        async function togSlide(id, st) { await api({action:'toggle_slide', id:id, active:st}); loadEditSlides(); }
        async function delSlide(id) { await api({action:'delete_slide', slide_id:id}); loadEditSlides(); }
    </script>
</body>
</html>
